<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>光儲合一投資效益評估</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Bootstrap 4（CDN） -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" />

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      margin: 20px;
      font-family: "Microsoft JhengHei", Arial, sans-serif;
      background: linear-gradient(to right, #0f2027, #203a43, #2c5364);
      color: #ffffff;
    }

    h1, h2, h3 {
      font-weight:bold;
    }
    h1 { color:#AEE1F9; font-size:32px; text-align:center; margin-bottom:30px; }
    h2 { color:#ffffff; font-size:24px; margin-bottom:15px; }
    h3 { color:#ffffff; font-size:20px; }

    .section-block {
      border: 1px solid #444;
      padding: 15px;
      margin-bottom: 15px;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      position:relative;
    }

    label {
      font-weight:bold;
    }

    .input-tooltip {
      cursor:pointer;
      color:#aee1f9;
      font-weight:normal;
      text-decoration: underline dotted;
    }

    .tooltip-text {
      visibility: hidden;
      width: 300px;
      background-color: rgba(0,0,0,0.8);
      color: #fff;
      text-align: left;
      border-radius: 6px;
      padding: 10px;
      position: absolute;
      z-index: 100;
      bottom: 120%;
      left: 50%;
      margin-left: -150px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      font-size: 14px;
    }
    .tooltip-container:hover .tooltip-text {
      visibility: visible;
    }

    .table thead th {
      background-color: #333;
      color:#fff;
      white-space: nowrap;
      font-weight:bold;
      text-align:center;
    }
    .table tbody tr td {
      background:#fff;
      color:#000;
      vertical-align: middle;
      text-align:right;
      white-space: nowrap;
    }
    .table tbody tr td:first-child {
      text-align:center;
    }

    .negative-value {
      color: red !important;
    }

    .chart-container {
      position: relative;
      height: 400px;
      background: #fff;
      border-radius: 8px;
      padding:10px;
    }

    .chart-info {
      text-align: center;
      margin-top: 10px;
      font-weight: bold;
      font-size: 16px;
      color:#fff;
    }

    .btn-expand {
      position: absolute;
      right: 10px;
      top: 10px;
      background: rgba(255,255,255,0.3);
      border:none;
      color:#fff;
      font-weight:bold;
      border-radius:5px;
      cursor:pointer;
      padding:5px 10px;
    }
    .btn-expand:hover {
      background: rgba(255,255,255,0.6);
    }

    .modal {
      display: none; 
      position: fixed; 
      z-index: 999;
      padding-top: 100px;
      left:0; top:0; width:100%; height:100%;
      overflow:auto;
      background-color: rgba(0,0,0,0.8);
    }

    .modal-content {
      background: #fff;
      margin: auto;
      padding:20px;
      width:90%;
      max-width:1200px;
      border-radius:8px;
      position:relative;
      color:#000;
      font-size:16px;
      line-height:1.6;
    }

    .close-btn {
      position:absolute;
      top:10px; right:10px;
      background: #ccc;
      border:none;
      border-radius:50%;
      width:30px; height:30px;
      text-align:center; line-height:30px;
      cursor:pointer;
      font-weight:bold;
    }
    .close-btn:hover {
      background:#aaa;
    }

    .top-right-print {
      position:absolute;
      top:20px; right:20px;
      cursor:pointer;
    }
    .top-right-print img {
      width:32px; height:32px;
    }

    .copy-mail-btn {
      background:none;
      border:none;
      color:#007bff;
      text-decoration:underline;
      cursor:pointer;
      padding:0;
      font-size:14px;
    }

    .pie-chart-container {
      position:relative;
      width:100%;
      max-width:300px;
      margin: 0 auto;
    }

    .formula-block {
      background:rgba(255,255,255,0.1);
      border-radius:8px;
      padding:10px;
      margin-top:10px;
    }
    .formula-row {
      display:flex;
      flex-wrap:wrap;
      justify-content:space-between;
    }
    .formula-col {
      flex:0 0 48%;
      background:rgba(255,255,255,0.2);
      border-radius:5px;
      padding:10px;
      margin-bottom:10px;
    }
    .formula-col h5 {
      font-weight:bold;
      color:#aee1f9;
      margin-bottom:10px;
    }
    .formula-col p {
      color:#fff;
      line-height:1.4;
    }

    .triple-formula-row {
      display:flex;
      flex-wrap:nowrap;
      justify-content:space-between;
      gap:10px;
    }
    .triple-formula-col {
      flex:0 0 32%;
      background:rgba(255,255,255,0.2);
      border-radius:5px;
      padding:10px;
    }

    @media print {
      .btn-expand, .top-right-print, #loginContainer {
        display:none!important;
      }
      body {
        background:#fff;
        color:#000;
      }
      .section-block {
        background:#fff;
        color:#000;
      }
    }

    .theme-charts {
      margin-top:30px;
    }
    .theme-charts h3 {
      text-align:center;
      margin-bottom:20px;
    }

    .lifetime-row {
      text-align:center; 
      color:#fff; 
      margin-top:10px;
    }
    .lifetime-row div {
      display:inline-block; 
      margin:0 10px;
    }
    .lifetime-row strong {
      color:#fff; 
    }

    /* 法規說明modal內容排版 */
    .regulation-content h4 {
      font-weight:bold;
      margin-top:20px;
      margin-bottom:10px;
      font-size:20px;
    }
    .regulation-content p {
      margin-bottom:10px;
    }
    .regulation-content {
      max-height:70vh;
      overflow-y:auto;
    }
  </style>
</head>

<body>

<!-- 登入區塊 -->
<div id="loginContainer">
  <h1>登入系統</h1>
  <div class="card mx-auto" style="max-width:400px;">
    <div class="card-body">
      <div class="form-group">
        <label>使用者名稱</label>
        <input type="text" class="form-control" id="username" placeholder="輸入帳號名稱" style="max-width:300px;">
      </div>
      <div class="form-group">
        <label>密碼</label>
        <input type="password" class="form-control" id="password" placeholder="輸入密碼" style="max-width:300px;">
        <small class="form-text text-light">
          若不確定密碼，請點擊 
          <button class="copy-mail-btn" onclick="copyMail()">點此複製信箱</button>
          並聯繫支援窗口
        </small>
      </div>
      <button class="btn btn-primary w-100" onclick="login()">登入</button>
    </div>
  </div>
</div>

<!-- 主內容區塊 -->
<div id="mainContent" style="display:none; position:relative;">
  <div class="top-right-print" onclick="window.print()">
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABJ0lEQVR4nJWSr0rDUBCHZ1jVCFArrwMdQJGwiCQitpsgHkBGSzdAt2A5GtoAewFF6OS2tkWEnqpaEcushDdnFjh73e+/2udZQ90w4/EmAHciAiPZ4GY7JKRShsUyVkH2ZEKA1c6RfMQnP88gHzjIj+di2KD55XnkASzytE/YOXzF3MBUPfAMvV9Z9alrheneybbkLMmN6eQK1tTQLu7ON4kkN3AFRQDXoR5VStZ2B6rxH/p9HUH4zSIi99iW9Qv/Rp5GZ1ZkKeZrwkq/AZrTs7rTGe3aO31Zu9tmXb3q5AWlsZQNITuQcQ4scdhkrRKcJOGxlgsxeDzFQO7lHGSKzlsYBvOrCKgT6FlS72B8xhjt4XkIVNSbKFt0UZUzVX5fSufn1FHcx3SypuDjJU9AAAAAElFTkSuQmCC" alt="Print Icon"/>
  </div>
  <h1>光儲合一投資效益評估</h1>

  <!-- 輸入參數區：PV與BESS並排 -->
  <div class="row">
    <div class="col-md-6">
      <div class="section-block">
        <h2>輸入參數 - PV 相關</h2>
        <div class="form-row">
          <div class="form-group col-md-6">
            <label class="input-tooltip" data-tooltip="剩餘可用的饋線容量，用於並網發電之規模參考">剩餘饋線容量 (kW)</label>
            <input type="number" class="form-control" id="p3" value="1000">
          </div>
          <div class="form-group col-md-6">
            <label class="input-tooltip" data-tooltip="光伏系統的安裝容量，以 kW 為單位">PV 容量 (kW)</label>
            <input type="number" class="form-control" id="p2" value="6000">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group col-md-6">
            <label class="input-tooltip" data-tooltip="日均可利用日照小時數">年均日照量 (h/day)</label>
            <input type="number" step="0.1" class="form-control" id="dailySun" value="3.0">
          </div>
          <div class="form-group col-md-6">
            <label class="input-tooltip" data-tooltip="全年中適合發電的晴天比例，0~1">年度晴天比例 (B)</label>
            <input type="number" step="0.1" class="form-control" id="sunnyRatio" value="1.0">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group col-md-6">
            <label class="input-tooltip" data-tooltip="初始年度的電價 (NTD/kWh)">初始 PV 電價 (F1_0, NTD/kWh)</label>
            <input type="number" step="0.1" class="form-control" id="f1_0" value="4.7">
          </div>
          <div class="form-group col-md-6">
            <label class="input-tooltip" data-tooltip="電價年增長率(%)">電價年增長率 (%)</label>
            <input type="number" step="0.1" class="form-control" id="f1_growth" value="0.0">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group col-md-6">
            <label class="input-tooltip" data-tooltip="PV 每年衰減率(%)">PV 衰減率 (d_PV)</label>
            <input type="number" step="0.1" class="form-control" id="decayPV" value="1.0">
          </div>
          <div class="form-group col-md-6">
            <label class="input-tooltip" data-tooltip="PV 設備建置成本 (NTD/kW)">PV 建置成本</label>
            <input type="number" class="form-control" id="c2" value="45000">
          </div>
        </div>
        
        <!-- 新增「光儲配置建議」區域 -->
        <div class="section-block" style="background:rgba(255,255,255,0.2); color:#fff;">
          <h2>光儲配置建議</h2>
          <div class="form-row">
            <div class="form-group col-md-6">
              <label class="input-tooltip" data-tooltip="建議為 10% ~ 40%">光儲配置比例 (%)</label>
              <input type="number" step="1" class="form-control" id="bessRatio" value="20">
            </div>
            <div class="form-group col-md-6">
              <label class="input-tooltip" data-tooltip="建議為法規規定為 1.5 倍">額定容量比例係數</label>
              <input type="number" step="0.1" class="form-control" id="capacityFactor" value="1.5">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group col-md-12">
              <button class="btn btn-info" onclick="calcBessSuggestion()">試算</button>
            </div>
          </div>

          <div id="bessSuggestionResult" style="display:none;">
            <p class="input-tooltip" data-tooltip="公式: PV容量 × 光儲配置比例">BESS標稱功率建議值 (kW): <span id="suggestedBessPower"></span></p>
            <p class="input-tooltip" data-tooltip="公式: BESS標稱功率建議值(kW) × 額定容量比例係數">PV分配儲能裝置容量 (kWp): <span id="suggestedPvAlloc"></span></p>
            <p class="input-tooltip" data-tooltip="公式: PV分配儲能裝置容量(kWp) × 年均日照量(h/day) × BESS初始效率(%)">PV充入BESS電能 (kWh): <span id="suggestedPvToBess"></span></p>
            <p class="input-tooltip" data-tooltip="公式: PV充入BESS電能(kWh) ÷ BESS標稱功率建議值(kW)">BESS時效建議值 (hours): <span id="suggestedBessDuration"></span></p>
          </div>

          <!-- 光儲法規說明按鈕 -->
          <div class="form-row">
            <div class="form-group col-md-12">
              <button class="btn btn-warning" onclick="openModal('regulation')">光儲法規說明</button>
            </div>
          </div>
        </div>
        <!-- 光儲配置建議區域結束 -->
        
      </div>
    </div>
    <div class="col-md-6">
      <div class="section-block">
        <h2>輸入參數 - BESS 相關</h2>
        <div class="form-row">
          <div class="form-group col-md-6">
            <label class="input-tooltip" data-tooltip="儲能系統初始放電效率（%）">BESS 初始效率 (%)</label>
            <input type="number" step="1" class="form-control" id="etaBess0" value="70">
          </div>
          <div class="form-group col-md-6">
            <label class="input-tooltip" data-tooltip="BESS 額定功率 (kW)">BESS 額定功率 (kW)</label>
            <input type="number" class="form-control" id="pBess" value="5000">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group col-md-6">
            <label class="input-tooltip" data-tooltip="BESS 可連續放電時數">BESS 放電時數 (hr)</label>
            <input type="number" step="0.01" class="form-control" id="tBess" value="6">
          </div>
          <div class="form-group col-md-6">
            <label class="input-tooltip" data-tooltip="BESS 年度效率衰減率(%)">BESS 衰減率 (d_BESS)</label>
            <input type="number" step="0.1" class="form-control" id="decayBESS" value="0.1">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group col-md-6">
            <label class="input-tooltip" data-tooltip="BESS 容量獲標率(0~1)">容量獲標率 (A)</label>
            <input type="number" step="0.1" class="form-control" id="awardRate" value="1.0">
          </div>
          <div class="form-group col-md-6">
            <label class="input-tooltip" data-tooltip="BESS 容量費 (NTD/kW)">BESS 容量費</label>
            <input type="number" step="0.1" class="form-control" id="fCap" value="8.5">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group col-md-6">
            <label class="input-tooltip" data-tooltip="BESS 能源費 (NTD/kWh)">BESS 能源費</label>
            <input type="number" step="0.1" class="form-control" id="fEne" value="5.5">
          </div>
          <div class="form-group col-md-6">
            <label class="input-tooltip" data-tooltip="BESS 建置成本 (NTD/kWh)">BESS 建置成本</label>
            <input type="number" class="form-control" id="c1" value="21000">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group col-md-4">
            <label class="input-tooltip" data-tooltip="O&M 成本比例(%)">O&M 成本比率 (ζ)</label>
            <input type="number" step="0.1" class="form-control" id="omRatio" value="6.0">
          </div>
          <div class="form-group col-md-4">
            <label class="input-tooltip" data-tooltip="BESS 周邊設備電價成本(NTD/kWh)">泵浦電價</label>
            <input type="number" step="0.1" class="form-control" id="pumpElecPrice" value="4.5">
          </div>
          <div class="form-group col-md-4">
            <label class="input-tooltip" data-tooltip="O&M 年增長率(%)">O&M 年增率</label>
            <input type="number" step="0.1" class="form-control" id="omGrowth" value="1">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group col-md-6">
            <label class="input-tooltip" data-tooltip="專案壽命(年)">專案壽命 (L)</label>
            <input type="number" class="form-control" id="projectLifespan" value="20">
          </div>
          <div class="form-group col-md-6">
            <label class="input-tooltip" data-tooltip="折現率(%)">折現率 (r)</label>
            <input type="number" step="0.1" class="form-control" id="discountRate" value="3.0">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 貸款參數 -->
  <div class="section-block">
    <h2>輸入參數 - 貸款相關</h2>
    <div class="form-row">
      <div class="form-group col-md-3">
        <label class="input-tooltip" data-tooltip="貸款比例(%)">借貸比例 (%)</label>
        <input type="number" step="1" class="form-control" id="loanRatio" value="70">
      </div>
      <div class="form-group col-md-3">
        <label class="input-tooltip" data-tooltip="年利率(%)">年利率 (%)</label>
        <input type="number" step="0.1" class="form-control" id="loanInterest" value="2">
      </div>
      <div class="form-group col-md-3">
        <label class="input-tooltip" data-tooltip="借貸年數">借貸年數</label>
        <input type="number" class="form-control" id="loanYears" value="20">
      </div>
      <div class="form-group col-md-3">
        <label class="input-tooltip" data-tooltip="有貸款情境下的折現率(%)">有貸款折現率 (%)</label>
        <input type="number" step="0.1" class="form-control" id="discountRateLoan" value="3.0">
      </div>
    </div>

    <div class="form-row">
      <div class="form-group col-md-6">
        <label class="input-tooltip" data-tooltip="還款模式">選擇還款模式</label>
        <select class="form-control" id="repaymentMode">
          <option value="equalPrincipalInterest">等額本息還款</option>
          <option value="equalPrincipal">等額本金還款</option>
        </select>
      </div>
      <div class="form-group col-md-6"></div>
    </div>

    <!-- 貸款公式展示 -->
    <div class="formula-block">
      <h3>貸款公式展示</h3>
      <div class="formula-row">
        <div class="formula-col">
          <h5>等額本息還款</h5>
          <p>
            \( R = \frac{P \cdot i \cdot (1+i)^n}{(1+i)^n - 1} \)<br><br>
            P：貸款本金<br>
            i：月利率 (年利率/12)<br>
            n：期數(月)<br>
            R：每月還款額
          </p>
        </div>
        <div class="formula-col">
          <h5>等額本金還款</h5>
          <p>
            \( R_m = \frac{P}{n} + (P - \frac{P}{n}(m-1)) \cdot i \)<br><br>
            P：貸款本金<br>
            i：月利率<br>
            n：期數(月)<br>
            m：第m期<br>
            R_m：第m期還款額
          </p>
        </div>
      </div>
    </div>

    <!-- NPV, IRR, ROI 公式展示 -->
    <div class="formula-block">
      <h3>NPV, IRR, ROI 公式展示</h3>
      <div class="triple-formula-row">
        <div class="triple-formula-col">
          <h5>NPV公式：</h5>
          <p>
            \( NPV = \sum_{t=1}^{L}\frac{Net Cash Flow_t}{(1+r)^t} - Initial Investment \)<br><br>
            指標意義：<br>  
            NPV > 0，表示投資案有正面價值<br>
          </p>
        </div>
        <div class="triple-formula-col">
          <h5>IRR公式：</h5>
          <p>
            \( \sum_{t=1}^{L}\frac{Net Cash Flow_t}{(1+IRR)^t} = 0 \)<br><br>
            指標意義：<br>  
            IRR越大，投資報酬率越高<br>
          </p>
        </div>
        <div class="triple-formula-col">
          <h5>ROI公式：</h5>
          <p>
            \( ROI = \frac{\sum_{t=1}^{L}Net Cash Flow_t - |Initial Investment|}{|Initial Investment|} \)<br><br>
            指標意義：<br>  
            ROI越高，表示投資回報越大<br>
          </p>
        </div>
      </div>
    </div>

    <div class="form-row mt-3">
      <div class="form-group col-md-12">
        <button class="btn btn-primary" style="width:200px;" onclick="calculateResult()">開始計算</button>
      </div>
    </div>
  </div>

  <!-- 初始單日電能量結果 與 投資比例 -->
  <div class="row">
    <div class="col-md-6 section-block">
      <h2>投資成本與比例</h2>
      <p><strong>PV 投資金額：</strong><span id="pvInvestVal"></span></p>
      <p><strong>BESS 投資金額：</strong><span id="bessInvestVal"></span></p>
      <p><strong style="color:#fff;">總投資金額：</strong><span id="totalInvestVal"></span></p>
      <div class="pie-chart-container">
        <canvas id="investmentPieChart"></canvas>
      </div>
    </div>

    <div class="col-md-6 section-block">
      <h2>壽命期內支出構成</h2>
    	<p><strong>初始的支出：</strong><span id="initialCostVal"></span></p>
        <p><strong>利息：</strong><span id="totalInterestVal"></span></p>
        <p><strong>本金償還：</strong><span id="totalPrincipalVal"></span></p>
        <p><strong>借貸支出總金額：</strong><span id="totalLifeCostVal"></span></p>
      <div class="pie-chart-container">
        <canvas id="lifetimeCostPieChart"></canvas>
      </div>
      <div class="lifetime-row">
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6 section-block">
      <h2>初始單日電能量計算結果</h2>
      <p><strong>W1 (PV日發電量):</strong> <span id="w1Val"></span> kWh/day</p>
      <p><strong>W2 (BESS容量):</strong> <span id="w2Val"></span> kWh</p>
      <p><strong>W3 (BESS可儲存PV電量):</strong> <span id="w3Val"></span> kWh/day</p>
      <p><strong>W4 (BESS充滿所需PV電量):</strong> <span id="w4Val"></span> kWh/day</p>
      <p><strong>W5 (PV直售剩餘電量):</strong> <span id="w5Val"></span> kWh/day</p>
      <p><strong>W6 (泵浦單日消耗電量):</strong> <span id="w6Val"></span> kWh/day</p>
    </div>
  </div>

  <!-- 原有綜合趨勢圖 -->
  <div class="row">
    <div class="col-md-6 section-block" style="position:relative;">
      <h2>無貸款情境年收益趨勢圖</h2>
      <button class="btn-expand" onclick="openModal('noLoan')">展開</button>
      <div class="chart-container">
        <canvas id="noLoanChart"></canvas>
      </div>
      <div class="chart-info" id="noLoanChartInfo"></div>
    </div>
    <div class="col-md-6 section-block" style="position:relative;">
      <h2>有貸款情境年收益趨勢圖</h2>
      <button class="btn-expand" onclick="openModal('loan')">展開</button>
      <div class="chart-container">
        <canvas id="loanChart"></canvas>
      </div>
      <div class="chart-info" id="loanChartInfo"></div>
    </div>
  </div>

  <!-- 新增多主題趨勢圖區域 -->
  <div class="theme-charts">
    <h3>無貸款情境 - 多主題趨勢圖</h3>
    <div class="row">
      <div class="col-md-4 section-block">
        <h2>收入趨勢圖 (No Loan)</h2>
        <div class="chart-container">
          <canvas id="noLoanRevenueChart"></canvas>
        </div>
      </div>
      <div class="col-md-4 section-block">
        <h2>成本趨勢圖 (No Loan)</h2>
        <div class="chart-container">
          <canvas id="noLoanCostChart"></canvas>
        </div>
      </div>
      <div class="col-md-4 section-block">
        <h2>淨收益與累積CF趨勢圖 (No Loan)</h2>
        <div class="chart-container">
          <canvas id="noLoanCFChart"></canvas>
        </div>
      </div>
    </div>

    <h3>有貸款情境 - 多主題趨勢圖</h3>
    <div class="row">
      <div class="col-md-4 section-block">
        <h2>收入趨勢圖 (Loan)</h2>
        <div class="chart-container">
          <canvas id="loanRevenueChart"></canvas>
        </div>
      </div>
      <div class="col-md-4 section-block">
        <h2>成本趨勢圖 (Loan)</h2>
        <div class="chart-container">
          <canvas id="loanCostChart"></canvas>
        </div>
      </div>
      <div class="col-md-4 section-block">
        <h2>淨收益與累積CF趨勢圖 (Loan)</h2>
        <div class="chart-container">
          <canvas id="loanCFChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal for Reports -->
<div id="noLoanModal" class="modal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeModal('noLoan')">&times;</button>
    <h3>無貸款情境 - 年度收益報表</h3>
    <div id="noLoanResultArea"></div>
  </div>
</div>

<div id="loanModal" class="modal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeModal('loan')">&times;</button>
    <h3>有貸款情境 - 年度收益報表</h3>
    <div id="loanResultArea"></div>
  </div>
</div>

<!-- 光儲法規說明Modal -->
<div id="regulationModal" class="modal">
  <div class="modal-content regulation-content">
    <button class="close-btn" onclick="closeModal('regulation')">&times;</button>
    <h4>壹、政府激勵措施與法規</h4>
    <p>政府補助：各項補助計畫支援太陽能與儲能專案，包括住宅型專案。</p>
    <p>碳排放係數：能源局設定電力碳排放係數為 0.495，綠色證書可供每 1000 kWh 綠電使用。</p>
    <p>新建築要求：新建築物必須在屋頂設置太陽能系統。</p>
    <p>投標程序：太陽能加儲能專案採競爭性投標，根據儲能容量與成本進行評估。</p>
    <p>最低容量要求：投標最低太陽能容量為 1 MW。</p>
    <p>評估標準：根據儲能容量及能量釋放速率評估。</p>
    <p>容量費率：投標基於容量費率，最高中標價格將成為所有中標專案的收費標準。</p>
    <p>電網連接審查：儲能系統須通過電網連接審查，並在規定期限內完成。</p>
    <p>安全與消防法規：針對儲能系統制定嚴格法規，聚焦安全、防火及土地使用。</p>
    <p>電池系統認證 (VPC)：電池系統必須通過認證，以符合安全標準。</p>
    <p>設備產地限制：完整儲能系統不得源自中國。</p>

    <h4>貳、光儲合一的規範與運作規定</h4>
    <p>電池容量要求：儲能系統的有效功率需乘以 2.61，得出所需電池容量。</p>
    <p>電網連接時限：現有太陽能場址需於 13 個月內加裝儲能系統；新場址則需於一年內完成。</p>
    <p>電網容量提升：光電容量為儲能系統額定容量的 1.5 倍：</p>
    <p>可透過減少送入電網的太陽能容量或增加裝置的太陽能發電量來達成。</p>
    <p>充放電規範：允許於特定時段（上午 9 點至下午 2 點 30 分）充電，並於傍晚尖峰時段放電。</p>
    <p>電力來源：儲能系統充電所用電力必須來自太陽能，而非電網。</p>
    <p>放電要求：若太陽能發電於下午 4 點 30 分至 6 點間連續 15 分鐘低於容量的30%，儲能系統需放電1小時。</p>
    <p>電網頻率響應：若電網頻率降至59.6 Hz以下，系統需停止充電並放電5分鐘。</p>
    <p>通訊協議：系統需符合數據通訊協議，並安全傳輸數據至台電控制中心。</p>
    <p>數據紀錄：對電錶精確度及數據紀錄頻率有特定標準。</p>
    <p>性能測試：要求進行全功率充放電測試，確保系統至少可運行2.61小時。</p>
    <p>應急反應：儲能系統需在1分鐘內回應緊急指令，並在完成後1分鐘內返回原定運行。</p>

    <h4>叁、市場參與與規範</h4>
    <p>容量競標：企業向台電競標提供儲能容量合約。</p>
    <p>雙重費率：包括電池容量費用及夜間放電能量費用，能量費以短期購電價格的1.25倍計算。</p>
    <p>調度優先權：台電控制儲能資產的調度，僅限規定充電時段除外。</p>
    <p>數據報告：需持續報告數據，以確保符合規範。</p>

    <h4>肆、關鍵問題與疑慮</h4>
    <p>地方政府角色：地方政府主要在電網連接申請的公聽程序中發揮作用。</p>
    <p>2.61 比率：台電根據成本與調度考量設定2.61的電池容量與輸出功率比率，為最低要求。</p>
    <p>太陽能加儲能成本：具體成本受多項因素影響。</p>
    <p>PCS 容量：PCS 輸出容量與太陽能發電量及電網連接容量減量相關，視專案需求而定。</p>
    <p>自我消耗：系統主要為向台電售電設計，非用於自我消耗再並網售電。</p>
    <p>系統負載：系統需由自設太陽能供電，而非電網供電，但詳情尚不完全明確。</p>
    <p>電網連接前測試：關於儲能系統連接前測試時的電力來源尚有不確定性。</p>

  </div>
</div>

<script>
function copyMail(){
  const email="mos41941@mail.pewc.com.tw";
  navigator.clipboard.writeText(email).then(()=>{
    alert("複製信箱地址成功");
  })
}

function login(){
  let now = new Date();
  let month = now.getMonth()+1;
  let day = now.getDate();
  let sum = month+day;
  let sumStr = (sum<10)?("0"+sum):sum;
  let correctPass = "PEWC2024"+sumStr;

  const user = document.getElementById("username").value;
  const pass = document.getElementById("password").value;
  if(user==="PEWC" && pass===correctPass){
    document.getElementById("loginContainer").style.display="none";
    document.getElementById("mainContent").style.display="block";
  } else {
    alert("使用者名稱或密碼錯誤！");
  }
}

function toCurrency(num){
  if(num===undefined || num===null) num=0;
  let n = Math.round(num);
  return "NT$" + n.toLocaleString("en-US");
}

function computeNPV(cashFlowArr, discountRate){
  let npv=0;
  for(let t=0; t<cashFlowArr.length; t++){
    npv += cashFlowArr[t]/Math.pow((1+discountRate),(t));
  }
  return npv;
}

function computeIRR(cashFlowArr){
  let lower=-0.9999, upper=1, maxIter=10000;
  for(let i=0; i<maxIter; i++){
    let mid=(upper+lower)/2;
    let npv=0;
    for(let t=0; t<cashFlowArr.length; t++){
      npv += cashFlowArr[t]/Math.pow((1+mid),(t));
    }
    if(Math.abs(npv)<1e-8) return mid;
    if(npv>0) lower=mid; else upper=mid;
  }
  return (upper+lower)/2;
}

function computeROI(cashFlowArr){
  let initialInvestment = -cashFlowArr[0];
  let cum = 0;
  for(let i=0; i<cashFlowArr.length; i++){
    cum += cashFlowArr[i];
  }
  let totalNetGain = cum - initialInvestment; 
  return totalNetGain/initialInvestment;
}

function calcEqualPrincipalInterestDetail(P, annualInterest, years){
  let i = annualInterest/12;
  let n = years*12;
  let R = P * i * Math.pow(1+i,n) / (Math.pow(1+i,n)-1);
  let schedule=[];
  let remaining = P;

  for(let y=1; y<=years; y++){
    let yearInterest=0;
    let yearPrincipal=0;
    for(let m=1; m<=12; m++){
      let interest_m = remaining * i;
      let principal_m = R - interest_m;
      yearInterest += interest_m;
      yearPrincipal += principal_m;
      remaining -= principal_m;
    }
    schedule.push({year:y,interest:yearInterest,principal:yearPrincipal,total:yearInterest+yearPrincipal});
  }
  return schedule;
}

function calcEqualPrincipalDetail(P, annualInterest, years){
  let i = annualInterest/12;
  let n = years*12;
  let schedule=[];
  let principalEachYear = P/years;
  let remaining = P;

  for(let y=1; y<=years; y++){
    let yearInterest=0;
    for(let m=1; m<=12; m++){
      let interest_m = remaining * i;
      yearInterest += interest_m;
      remaining -= (P/n);
    }
    schedule.push({year:y,interest:yearInterest,principal:principalEachYear,total:principalEachYear+yearInterest});
  }
  return schedule;
}

function drawStackedChart(ctxId, labels, 
                          pvRevData, bessRevData, 
                          pumpCostData, omCostData, interestData,
                          netIncomeData, 
                          title, npv, irr, roi,
                          unifiedMax){
  let ctx = document.getElementById(ctxId).getContext('2d');
  if(window[ctxId+"Instance"]){
    window[ctxId+"Instance"].destroy();
  }

  let detailText = `
    <strong>NPV公式：</strong><br>
    NPV = Σ(NetCF_t/(1+r)^t) - Initial Investment<br><br>
    <strong>IRR公式：</strong><br>
    Σ(NetCF_t/(1+IRR)^t) = 0<br><br>
    <strong>ROI公式：</strong><br>
    ROI = (Σ(NetCF_t) - |Initial Investment|)/|Initial Investment|
  `;

  let npvText = (npv/1000000).toFixed(2)+"百萬元";
  let irrText = (irr*100).toFixed(2)+"%";
  let roiText = (roi*100).toFixed(2)+"%";

  window[ctxId+"Instance"] = new Chart(ctx, {
    type:'bar',
    data:{
      labels: labels,
      datasets:[
        {
          label:'PV Operating Revenue',
          data:pvRevData,
          backgroundColor:'#1565C0', 
          stack:'revenue'
        },
        {
          label:'BESS Operating Revenue',
          data:bessRevData,
          backgroundColor:'#42A5F5',
          stack:'revenue'
        },
        {
          label:'Interest',
          data:interestData.map(x=>Math.abs(x)),
          backgroundColor:'#7E57C2',
          stack:'expense'
        },
        {
          label:'O&M Cost',
          data:omCostData.map(x=>Math.abs(x)),
          backgroundColor:'#9575CD',
          stack:'expense'
        },
        {
          label:'Pump Operating Cost',
          data:pumpCostData.map(x=>Math.abs(x)),
          backgroundColor:'#B39DDB', 
          stack:'expense'
        },
        {
          type:'line',
          label:'Net Operating CF',
          data:netIncomeData,
          borderColor:'#66bb6a',
          backgroundColor:'#66bb6a',
          yAxisID:'yRight',
          tension:0.2,
          fill:false,
          order:0
        }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{
          position:'bottom',
          labels:{
            color:'#000',
            padding:20,
            boxWidth:20
          }
        },
        title:{
          display:true,
          text:title,
          color:'#000',
          font:{size:18,weight:'bold'}
        },
        tooltip:{
          callbacks:{
            label: function(context){
              let val = context.parsed.y||0;
              return context.dataset.label+": "+toCurrency(val.toFixed(0));
            }
          }
        }
      },
      scales:{
        yLeft:{
          type:'linear',
          position:'left',
          title:{ display:true, text:'Revenue/Cost (NTD)', color:'#000' },
          beginAtZero:true,
          stacked:true,
          suggestedMax: unifiedMax,
          ticks:{color:'#000'}
        },
        yRight:{
          type:'linear',
          position:'right',
          title:{ display:true, text:'Net Operating CF (NTD)', color:'#000' },
          grid:{ drawOnChartArea:false },
          beginAtZero:true,
          suggestedMax: unifiedMax,
          ticks:{color:'#000'}
        },
        x:{
          ticks:{color:'#000'}
        }
      }
    }
  });

  let infoDivId = ctxId==="noLoanChart"?"noLoanChartInfo":"loanChartInfo";
  document.getElementById(infoDivId).innerHTML = `
    <span class="tooltip-container">NPV: ${npvText}
      <span class="tooltip-text">${detailText}</span>
    </span> | 
    <span class="tooltip-container">IRR: ${irrText}
      <span class="tooltip-text">${detailText}</span>
    </span> | 
    <span class="tooltip-container">ROI: ${roiText}
      <span class="tooltip-text">${detailText}</span>
    </span>
  `;
}

function drawRevenueTrendChart(ctxId, labels, pvData, bessData, maxVal){
  let ctx = document.getElementById(ctxId).getContext('2d');
  if(window[ctxId+"Instance"]){
    window[ctxId+"Instance"].destroy();
  }
  window[ctxId+"Instance"] = new Chart(ctx, {
    type:'bar',
    data:{
      labels: labels,
      datasets:[
        {
          label:'PV Revenue',
          data:pvData,
          backgroundColor:'#1565C0'
        },
        {
          label:'BESS Revenue',
          data:bessData,
          backgroundColor:'#42A5F5'
        }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{
          position:'bottom',
          labels:{
            color:'#000',
            padding:20,
            boxWidth:20
          }
        },
        tooltip:{
          callbacks:{
            label: function(context){
              return context.dataset.label+": "+toCurrency(context.parsed.y);
            }
          }
        }
      },
      scales:{
        y:{
          beginAtZero:true,
          suggestedMax:maxVal,
          title:{display:true, text:'Revenue (NTD)', color:'#000'},
          ticks:{color:'#000'}
        },
        x:{
          ticks:{color:'#000'}
        }
      }
    }
  });
}

function drawCostTrendChart(ctxId, labels, pumpData, omData, interestData, maxVal){
  let ctx = document.getElementById(ctxId).getContext('2d');
  if(window[ctxId+"Instance"]){
    window[ctxId+"Instance"].destroy();
  }
  window[ctxId+"Instance"] = new Chart(ctx, {
    type:'bar',
    data:{
      labels: labels,
      datasets:[
        {
          label:'Interest',
          data:interestData.map(x=>Math.abs(x)),
          backgroundColor:'#7E57C2'
        },
        {
          label:'O&M Cost',
          data:omData.map(x=>Math.abs(x)),
          backgroundColor:'#9575CD'
        },
        {
          label:'Pump Cost',
          data:pumpData.map(x=>Math.abs(x)),
          backgroundColor:'#B39DDB'
        }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{
          position:'bottom',
          labels:{
            color:'#000',
            padding:20,
            boxWidth:20
          }
        },
        tooltip:{
          callbacks:{
            label: function(context){
              return context.dataset.label+": "+toCurrency(context.parsed.y);
            }
          }
        }
      },
      scales:{
        y:{
          beginAtZero:true,
          suggestedMax:maxVal,
          title:{display:true, text:'Cost (NTD)', color:'#000'},
          ticks:{color:'#000'}
        },
        x:{
          ticks:{color:'#000'}
        }
      }
    }
  });
}

function drawCFTrendChart(ctxId, labels, netCFData, cumCFData, maxVal){
  let ctx = document.getElementById(ctxId).getContext('2d');
  if(window[ctxId+"Instance"]){
    window[ctxId+"Instance"].destroy();
  }
  window[ctxId+"Instance"] = new Chart(ctx, {
    type:'line',
    data:{
      labels: labels,
      datasets:[
        {
          label:'Net Operating CF',
          data:netCFData,
          borderColor:'#66bb6a',
          backgroundColor:'#66bb6a',
          tension:0.2,
          fill:false,
          yAxisID:'yLeft'
        },
        {
          label:'Cumulative CF',
          data:cumCFData,
          borderColor:'#ffa726',
          backgroundColor:'#ffa726',
          tension:0.2,
          fill:false,
          yAxisID:'yRight'
        }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{
          position:'bottom',
          labels:{
            color:'#000',
            padding:20,
            boxWidth:20
          }
        },
        tooltip:{
          callbacks:{
            label: function(context){
              return context.dataset.label+": "+toCurrency(context.parsed.y);
            }
          }
        }
      },
      scales:{
        yLeft:{
          type:'linear',
          position:'left',
          beginAtZero:true,
          suggestedMax:maxVal,
          title:{display:true, text:'Net Operating CF (NTD)', color:'#000'},
          ticks:{color:'#000'}
        },
        yRight:{
          type:'linear',
          position:'right',
          beginAtZero:true,
          suggestedMax:maxVal*2, 
          title:{display:true, text:'Cumulative CF (NTD)', color:'#000'},
          grid:{ drawOnChartArea:false },
          ticks:{color:'#000'}
        },
        x:{
          ticks:{color:'#000'}
        }
      }
    }
  });
}

// 新增光儲配置試算功能
function calcBessSuggestion(){
  const pv = parseFloat(document.getElementById('p2').value);
  const bessRatio = parseFloat(document.getElementById('bessRatio').value)/100.0; //轉為比例
  const capFactor = parseFloat(document.getElementById('capacityFactor').value);
  const dailySun = parseFloat(document.getElementById('dailySun').value);
  const etaBess0 = parseFloat(document.getElementById('etaBess0').value)/100.0;

  let bessPower = pv * bessRatio; 
  let pvAlloc = bessPower * capFactor;
  if(pvAlloc < 1000){
    alert("請重新設定光儲比例");
  }
  let pvToBess = pvAlloc * dailySun * etaBess0;
  let bessDuration = pvToBess / bessPower;
  if(bessDuration < 2.61){
    alert("請增加額定容量比例係數");
  }

  document.getElementById('suggestedBessPower').textContent = Math.round(bessPower).toLocaleString()+" kW";
  document.getElementById('suggestedPvAlloc').textContent = Math.round(pvAlloc).toLocaleString()+" kWp";
  document.getElementById('suggestedPvToBess').textContent = Math.round(pvToBess).toLocaleString()+" kWh";
  document.getElementById('suggestedBessDuration').textContent = Math.round(bessDuration).toLocaleString()+" hours";
  document.getElementById('bessSuggestionResult').style.display="block";
}

function calculateResult(){
  const P2 = parseFloat(document.getElementById('p2').value);
  const dailySun = parseFloat(document.getElementById('dailySun').value);
  const sunnyRatio = parseFloat(document.getElementById('sunnyRatio').value);
  const F1_0 = parseFloat(document.getElementById('f1_0').value);
  const f1_growth = parseFloat(document.getElementById('f1_growth').value)/100.0;
  const d_PV = parseFloat(document.getElementById('decayPV').value)/100.0;
  const etaBess0 = parseFloat(document.getElementById('etaBess0').value)/100.0;
  const d_BESS = parseFloat(document.getElementById('decayBESS').value)/100.0;
  const P_BESS = parseFloat(document.getElementById('pBess').value);
  const t_BESS = parseFloat(document.getElementById('tBess').value);
  const awardRate = parseFloat(document.getElementById('awardRate').value);
  const F_cap = parseFloat(document.getElementById('fCap').value);
  const F_ene = parseFloat(document.getElementById('fEne').value);
  const L = parseInt(document.getElementById('projectLifespan').value);
  const r = parseFloat(document.getElementById('discountRate').value)/100.0;
  const zeta = parseFloat(document.getElementById('omRatio').value)/100.0;
  const omGrowth = parseFloat(document.getElementById('omGrowth').value)/100.0;
  const C2 = parseFloat(document.getElementById('c2').value);
  const C1 = parseFloat(document.getElementById('c1').value);
  const pumpElecPrice = parseFloat(document.getElementById('pumpElecPrice').value);
  const loanRatio = parseFloat(document.getElementById('loanRatio').value)/100.0;
  const loanInterest = parseFloat(document.getElementById('loanInterest').value)/100.0;
  const loanYears = parseInt(document.getElementById('loanYears').value);
  const discountRateLoan = parseFloat(document.getElementById('discountRateLoan').value)/100.0;
  const repaymentMode = document.getElementById('repaymentMode').value;

  const P6 = 0.08 * P_BESS;
  const tpump = 2 * t_BESS;
  const W6_daily = P6 * tpump;

  let W1 = P2 * dailySun; 
  let W2 = P_BESS * t_BESS;
  let W3 = W1 * etaBess0;
  let W4 = W2 / etaBess0;
  let W5 = (W3 > W2) ? (W1 - W4) : 0;

  document.getElementById('w1Val').textContent = Math.round(W1).toLocaleString();
  document.getElementById('w2Val').textContent = Math.round(W2).toLocaleString();
  document.getElementById('w3Val').textContent = Math.round(W3).toLocaleString();
  document.getElementById('w4Val').textContent = Math.round(W4).toLocaleString();
  document.getElementById('w5Val').textContent = Math.round(W5).toLocaleString();
  document.getElementById('w6Val').textContent = Math.round(W6_daily).toLocaleString();

  // 投資成本
  const Invest_PV = -(P2 * C2);
  const C_BESS_0 = P_BESS * t_BESS;
  const Invest_BESS = -(C_BESS_0 * C1);
  const Invest_total = Invest_PV + Invest_BESS;

  document.getElementById('pvInvestVal').textContent = toCurrency(-Invest_PV);
  document.getElementById('bessInvestVal').textContent = toCurrency(-Invest_BESS);
  document.getElementById('totalInvestVal').textContent = toCurrency(-(Invest_PV+Invest_BESS));

  let pvCost = Math.abs(Invest_PV);
  let bessCost = Math.abs(Invest_BESS);
  let totalCost = pvCost+bessCost;
  let pieCtx = document.getElementById("investmentPieChart").getContext('2d');
  if(window["pieInstance"]){
    window["pieInstance"].destroy();
  }
  window["pieInstance"] = new Chart(pieCtx, {
    type:'pie',
    data:{
      labels:["PV Invest","BESS Invest"],
      datasets:[{
        data:[pvCost,bessCost],
        backgroundColor:["#1565C0","#42A5F5"]
      }]
    },
    options:{
      plugins:{
        legend:{
          position:'bottom',
          labels:{
            color:'#000',
            padding:20,
            boxWidth:20
          }
        },
        tooltip:{
          callbacks:{
            label: function(context){
              let val = context.parsed||0;
              let per = (val/totalCost)*100;
              return context.label+": "+toCurrency(val)+" ("+per.toFixed(2)+"%)";
            }
          }
        }
      }
    }
  });

  let loanPrincipal = -Invest_total * loanRatio;
  let equityInvest = Invest_total - (-loanPrincipal);

  let loanSchedule=[];
  if(repaymentMode==="equalPrincipalInterest"){
    loanSchedule = calcEqualPrincipalInterestDetail(loanPrincipal, loanInterest, loanYears);
  } else {
    loanSchedule = calcEqualPrincipalDetail(loanPrincipal, loanInterest, loanYears);
  }

  let noLoanCF = [Invest_total];
  let noLoan_netCF = [Invest_total];
  let noLoan_cumCF = [Invest_total];

  let loanCF = [equityInvest];
  let loan_netCF = [equityInvest];
  let loan_cumCF = [equityInvest];

  let pvGenArr_noLoan=[0], bessGenArr_noLoan=[0], pvLostArr_noLoan=[0], pumpLostArr_noLoan=[0], pvRevArr_noLoan=[Invest_PV], bessRevArr_noLoan=[Invest_BESS], pumpCostArr_noLoan=[0], omArr_noLoan=[0], interestArr_noLoan=[0], principalArr_noLoan=[0], netArr_noLoan=[Invest_total], totalRevArr_noLoan=[Invest_total];

  let pvGenArr_loan=[0], bessGenArr_loan=[0], pvLostArr_loan=[0], pumpLostArr_loan=[0], pvRevArr_loan=[equityInvest], bessRevArr_loan=[0], pumpCostArr_loan=[0], omArr_loan=[0], interestArr_loan=[0], principalArr_loan=[0], netArr_loan=[equityInvest], totalRevArr_loan=[equityInvest];

  let totalInterest_loan = 0;
  let totalPrincipal_loan = 0;

  for(let i=1; i<=L; i++){
    let F1_i = F1_0 * Math.pow((1+f1_growth),(i-1));
    let SF_i = dailySun * Math.pow(1-d_PV,(i-1));
    let E_PV_day = P2 * SF_i;
    let E_PV_year = E_PV_day * 365 * sunnyRatio;

    let C_BESS_i = C_BESS_0 * Math.pow((1-d_BESS),(i-1));
    let etaBess_i = etaBess0 * Math.pow((1-d_BESS),(i-1));

    let dailyBESS_need = C_BESS_i / etaBess_i;
    let dailySurplus = E_PV_day>dailyBESS_need? (E_PV_day - dailyBESS_need) : 0;
    let E_surplus_year = dailySurplus*365*sunnyRatio;
    let E_BESS_year = (E_PV_day - dailySurplus)*etaBess_i*365*sunnyRatio;

    let pumpLostYear = W6_daily*365; 
    let pumpCost = -(pumpLostYear*pumpElecPrice);

    let R_PV = E_surplus_year*F1_i;
    let BESS_capacityFee = P_BESS*F_cap*awardRate;
    let BESS_energyFee = E_BESS_year*F_ene;
    let R_BESS = BESS_capacityFee+BESS_energyFee;
    let R_total = R_PV + R_BESS;

    let OandM = -( (Math.abs(Invest_total)*zeta / L) * Math.pow((1+omGrowth),(i-1)) );

    // 無貸款情境
    let netOperatingCF_noLoan = R_total + OandM + pumpCost;
    noLoan_netCF.push(netOperatingCF_noLoan);
    noLoan_cumCF.push(noLoan_cumCF[noLoan_cumCF.length-1] + netOperatingCF_noLoan);
    noLoanCF.push(netOperatingCF_noLoan);

    pvGenArr_noLoan.push(E_PV_year);
    bessGenArr_noLoan.push(E_BESS_year);
    pvLostArr_noLoan.push((E_PV_day*365*sunnyRatio) - E_surplus_year - E_BESS_year);
    pumpLostArr_noLoan.push(pumpLostYear);
    pvRevArr_noLoan.push(R_PV);
    bessRevArr_noLoan.push(R_BESS);
    pumpCostArr_noLoan.push(pumpCost);
    omArr_noLoan.push(OandM);
    interestArr_noLoan.push(0);
    principalArr_noLoan.push(0);
    netArr_noLoan.push(netOperatingCF_noLoan);
    totalRevArr_noLoan.push(R_total);

    // 有貸款情境
    let interest=0; 
    let principal=0;
    if(i<=loanYears){
      interest=loanSchedule[i-1].interest;
      principal=loanSchedule[i-1].principal;
    }
    totalInterest_loan += interest;
    totalPrincipal_loan += principal;

    let netOperatingCF_loan = R_total + OandM + pumpCost - interest;
    loan_netCF.push(netOperatingCF_loan);
    let thisYearCashFlow_loan = netOperatingCF_loan - principal;
    loan_cumCF.push(loan_cumCF[loan_cumCF.length-1]+thisYearCashFlow_loan);
    loanCF.push(thisYearCashFlow_loan);

    pvGenArr_loan.push(E_PV_year);
    bessGenArr_loan.push(E_BESS_year);
    pvLostArr_loan.push((E_PV_day*365*sunnyRatio) - E_surplus_year - E_BESS_year);
    pumpLostArr_loan.push(pumpLostYear);
    pvRevArr_loan.push(R_PV);
    bessRevArr_loan.push(R_BESS);
    pumpCostArr_loan.push(pumpCost);
    omArr_loan.push(OandM);
    interestArr_loan.push(-interest);
    principalArr_loan.push(-principal);
    netArr_loan.push(netOperatingCF_loan);
    totalRevArr_loan.push(R_total);
  }

  let noLoanNPV = computeNPV(noLoanCF, r);
  let noLoanIRR = computeIRR(noLoanCF);
  let noLoanROI = computeROI(noLoanCF);

  let loanNPV = computeNPV(loanCF, discountRateLoan);
  let loanIRR = computeIRR(loanCF);
  let loanROI = computeROI(loanCF);

  let noLoanHTML = `
  <div class="table-responsive">
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Year</th>
          <th>PV Annual Gen (kWh)</th>
          <th>BESS Annual Gen (kWh)</th>
          <th>PV Lost (kWh)</th>
          <th>Pump Lost (kWh)</th>
          <th>PV Revenue</th>
          <th>BESS Revenue</th>
          <th>Gross Revenue</th>
          <th>Pump Operating Cost</th>
          <th>O&M Cost</th>
          <th>Interest</th>
          <th>Principal Repayment</th>
          <th>Net Operating CF</th>
          <th>Cumulative CF</th>
        </tr>
      </thead>
      <tbody>
  `;
  for(let i=0; i<=L; i++){
    noLoanHTML += `
      <tr>
        <td>${i}</td>
        <td>${(pvGenArr_noLoan[i]||0).toLocaleString()}</td>
        <td>${(bessGenArr_noLoan[i]||0).toLocaleString()}</td>
        <td class="negative-value">${(pvLostArr_noLoan[i]||0).toLocaleString()}</td>
        <td class="negative-value">${(pumpLostArr_noLoan[i]||0).toLocaleString()}</td>
        <td class="${pvRevArr_noLoan[i]<0?'negative-value':''}">${toCurrency(pvRevArr_noLoan[i])}</td>
        <td class="${bessRevArr_noLoan[i]<0?'negative-value':''}">${toCurrency(bessRevArr_noLoan[i])}</td>
        <td class="${totalRevArr_noLoan[i]<0?'negative-value':''}">${toCurrency(totalRevArr_noLoan[i])}</td>
        <td class="${pumpCostArr_noLoan[i]<0?'negative-value':''}">${toCurrency(pumpCostArr_noLoan[i])}</td>
        <td class="${omArr_noLoan[i]<0?'negative-value':''}">${toCurrency(omArr_noLoan[i])}</td>
        <td>${toCurrency(interestArr_noLoan[i])}</td>
        <td>${toCurrency(principalArr_noLoan[i])}</td>
        <td class="${netArr_noLoan[i]<0?'negative-value':''}">${toCurrency(netArr_noLoan[i])}</td>
        <td class="${noLoan_cumCF[i]<0?'negative-value':''}">${toCurrency(noLoan_cumCF[i])}</td>
      </tr>
    `;
  }
  noLoanHTML+=`</tbody></table></div>`;
  document.getElementById("noLoanResultArea").innerHTML = noLoanHTML;

  let loanHTML = `
  <div class="table-responsive">
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Year</th>
          <th>PV Annual Gen (kWh)</th>
          <th>BESS Annual Gen (kWh)</th>
          <th>PV Lost (kWh)</th>
          <th>Pump Lost (kWh)</th>
          <th>PV Revenue</th>
          <th>BESS Revenue</th>
          <th>Gross Revenue</th>
          <th>Pump Operating Cost</th>
          <th>O&M Cost</th>
          <th>Interest</th>
          <th>Principal Repayment</th>
          <th>Net Operating CF</th>
          <th>Cumulative CF</th>
        </tr>
      </thead>
      <tbody>
  `;
  for(let i=0; i<=L; i++){
    loanHTML += `
      <tr>
        <td>${i}</td>
        <td>${(pvGenArr_loan[i]||0).toLocaleString()}</td>
        <td>${(bessGenArr_loan[i]||0).toLocaleString()}</td>
        <td class="negative-value">${(pvLostArr_loan[i]||0).toLocaleString()}</td>
        <td class="negative-value">${(pumpLostArr_loan[i]||0).toLocaleString()}</td>
        <td class="${pvRevArr_loan[i]<0?'negative-value':''}">${toCurrency(pvRevArr_loan[i])}</td>
        <td class="${bessRevArr_loan[i]<0?'negative-value':''}">${toCurrency(bessRevArr_loan[i])}</td>
        <td class="${totalRevArr_loan[i]<0?'negative-value':''}">${toCurrency(totalRevArr_loan[i])}</td>
        <td class="${pumpCostArr_loan[i]<0?'negative-value':''}">${toCurrency(pumpCostArr_loan[i])}</td>
        <td class="${omArr_loan[i]<0?'negative-value':''}">${toCurrency(omArr_loan[i])}</td>
        <td class="${interestArr_loan[i]<0?'negative-value':''}">${interestArr_loan[i]!==0?toCurrency(interestArr_loan[i]):0}</td>
        <td class="${principalArr_loan[i]<0?'negative-value':''}">${principalArr_loan[i]!==0?toCurrency(principalArr_loan[i]):0}</td>
        <td class="${netArr_loan[i]<0?'negative-value':''}">${toCurrency(netArr_loan[i])}</td>
        <td class="${loan_cumCF[i]<0?'negative-value':''}">${toCurrency(loan_cumCF[i])}</td>
      </tr>
    `;
  }
  loanHTML+=`</tbody></table></div>`;
  document.getElementById("loanResultArea").innerHTML = loanHTML;

  let yearsLabel = [...Array(L).keys()].map(x=>x+1);

  let allData_noLoan = pvRevArr_noLoan.slice(1).concat(bessRevArr_noLoan.slice(1), pumpCostArr_noLoan.slice(1).map(Math.abs), omArr_noLoan.slice(1).map(Math.abs), interestArr_noLoan.slice(1).map(Math.abs), netArr_noLoan.slice(1).map(Math.abs));
  let maxVal_noLoan = Math.max(...allData_noLoan,0);

  let allData_loan = pvRevArr_loan.slice(1).concat(bessRevArr_loan.slice(1), pumpCostArr_loan.slice(1).map(Math.abs), omArr_loan.slice(1).map(Math.abs), interestArr_loan.slice(1).map(Math.abs), netArr_loan.slice(1).map(Math.abs));
  let maxVal_loan = Math.max(...allData_loan,0);

  let unifiedMax = Math.max(maxVal_noLoan, maxVal_loan)*1.1;

  drawStackedChart("noLoanChart", yearsLabel, 
                   pvRevArr_noLoan.slice(1), bessRevArr_noLoan.slice(1),
                   pumpCostArr_noLoan.slice(1), omArr_noLoan.slice(1), interestArr_noLoan.slice(1),
                   netArr_noLoan.slice(1),
                   "無貸款情境年收益趨勢圖", noLoanNPV, noLoanIRR, noLoanROI,
                   unifiedMax);

  drawStackedChart("loanChart", yearsLabel,
                   pvRevArr_loan.slice(1), bessRevArr_loan.slice(1),
                   pumpCostArr_loan.slice(1), omArr_loan.slice(1), interestArr_loan.slice(1),
                   netArr_loan.slice(1),
                   "有貸款情境年收益趨勢圖", loanNPV, loanIRR, loanROI,
                   unifiedMax);

  drawRevenueTrendChart("noLoanRevenueChart", yearsLabel, pvRevArr_noLoan.slice(1), bessRevArr_noLoan.slice(1), unifiedMax);
  drawCostTrendChart("noLoanCostChart", yearsLabel, pumpCostArr_noLoan.slice(1), omArr_noLoan.slice(1), interestArr_noLoan.slice(1), unifiedMax);
  drawCFTrendChart("noLoanCFChart", yearsLabel, noLoan_netCF.slice(1), noLoan_cumCF.slice(1), unifiedMax);

  drawRevenueTrendChart("loanRevenueChart", yearsLabel, pvRevArr_loan.slice(1), bessRevArr_loan.slice(1), unifiedMax);
  drawCostTrendChart("loanCostChart", yearsLabel, pumpCostArr_loan.slice(1), omArr_loan.slice(1), interestArr_loan.slice(1), unifiedMax);
  drawCFTrendChart("loanCFChart", yearsLabel, loan_netCF.slice(1), loan_cumCF.slice(1), unifiedMax);

  // 修正初始的支出計算方式
  let initialCost = Math.abs(Invest_total)*(1 - loanRatio);
  let totalInterestCost = totalInterest_loan; 
  let totalPrincipalCost = totalPrincipal_loan; 
  let lifeTotal = initialCost+totalInterestCost+totalPrincipalCost;

  document.getElementById('initialCostVal').textContent = toCurrency(initialCost);
  document.getElementById('totalInterestVal').textContent = toCurrency(totalInterestCost);
  document.getElementById('totalPrincipalVal').textContent = toCurrency(totalPrincipalCost);
  document.getElementById('totalLifeCostVal').textContent = toCurrency(lifeTotal);

  let lifePieCtx = document.getElementById("lifetimeCostPieChart").getContext('2d');
  if(window["lifePieInstance"]){
    window["lifePieInstance"].destroy();
  }
  window["lifePieInstance"] = new Chart(lifePieCtx, {
    type:'pie',
    data:{
      labels:["初始的支出","利息","本金償還"],
      datasets:[{
        data:[initialCost,totalInterestCost,totalPrincipalCost],
        backgroundColor:["#1e88e5","#7E57C2","#8bc34a"]
      }]
    },
    options:{
      plugins:{
        legend:{
          position:'bottom',
          labels:{
            color:'#000',
            padding:20,
            boxWidth:20
          }
        },
        tooltip:{
          callbacks:{
            label: function(context){
              let val = context.parsed||0;
              let per = (val/lifeTotal)*100;
              return context.label+": "+toCurrency(val)+" ("+per.toFixed(2)+"%)";
            }
          }
        }
      }
    }
  });
}

function openModal(type){
  if(type==="regulation"){
    document.getElementById("regulationModal").style.display = "block";
  } else {
    document.getElementById(type+"Modal").style.display = "block";
  }
}
function closeModal(type){
  if(type==="regulation"){
    document.getElementById("regulationModal").style.display = "none";
  } else {
    document.getElementById(type+"Modal").style.display = "none";
  }
}

document.querySelectorAll('.input-tooltip').forEach(el=>{
  let txt = el.getAttribute('data-tooltip');
  el.classList.add('tooltip-container');
  let span = document.createElement('span');
  span.className = 'tooltip-text';
  span.innerHTML = txt;
  el.appendChild(span);
});
</script>

</body>
</html>
